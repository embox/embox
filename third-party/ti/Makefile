
ifeq ($(ROOT_DIR),)
$(error ROOT_DIR is not set.)
endif

ifeq ($(THIRDPARTY_DIR),)
$(error THIRDPARTY_DIR is not set.)
endif

AT=

DEVICE=TI816X
GPPOS=Embox
LOADER=ELF
SYSLINK_INSTALL_DIR=$(realpath $(THIRDPARTY_DIR))/ti/syslink_2_21_01_05
IPC_INSTALL_DIR=$(realpath $(THIRDPARTY_DIR))/ti/ipc_1_24_00_16
CGT_ARM_PREFIX=/<prefix>/arm-none-linux-gnueabi-
EMBOXKERNEL=$(realpath $(ROOT_DIR))

SYSLINK_BUILD_DEBUG=1
SYSLINK_BUILD_OPTIMIZE=0
SYSLINK_TRACE_ENABLE=1
SYSLINK_NOTIFYDRIVER=NOTIFYDRIVERSHM
SYSLINK_TRANSPORT=TRANSPORTSHM

SYSLINK_DRIVER=$(SYSLINK_INSTALL_DIR)/packages/ti/syslink/bin/TI816X/syslink.o
SYSLINK_LIB=$(SYSLINK_INSTALL_DIR)/packages/ti/syslink/lib/syslink.o_debug
SYSLINK_SLAVELOADER=$(SYSLINK_INSTALL_DIR)/packages/ti/syslink/bin/TI816X/samples/slaveloader_debug.o

EMBOX_IMPORTED_CPPFLAGS += -I$(abspath .)/include
EMBOX_IMPORTED_CPPFLAGS += $(filter -I%,$(EMBOX_CPPFLAGS))
EMBOX_IMPORTED_CPPFLAGS += $(filter -nostdinc,$(EMBOX_CPPFLAGS))
EMBOX_IMPORTED_CPPFLAGS += $(filter -D__EMBOX__,$(EMBOX_CPPFLAGS))

EMBOX_IMPORTED_CFLAGS   += $(EMBOX_IMPORTED_CPPFLAGS)
EMBOX_IMPORTED_CXXFLAGS += $(EMBOX_IMPORTED_CPPFLAGS)

EMBOX_IMPORTED_CFLAGS   += $(filter -fno-common,$(EMBOX_CFLAGS))
EMBOX_IMPORTED_CFLAGS   += $(filter -march%,$(EMBOX_CFLAGS))
EMBOX_IMPORTED_CFLAGS   += $(filter -fno-stack-protector,$(EMBOX_CFLAGS))
EMBOX_IMPORTED_CFLAGS   += $(filter -std=gnu99,$(EMBOX_CFLAGS))
EMBOX_IMPORTED_CFLAGS   += $(filter -mlittle-endian,$(EMBOX_CFLAGS))
EMBOX_IMPORTED_CFLAGS   += $(filter -mabi%,$(EMBOX_CFLAGS))
EMBOX_IMPORTED_CFLAGS   += $(filter -mapcs,$(EMBOX_CFLAGS))
EMBOX_IMPORTED_CFLAGS   += $(filter -msoft-float,$(EMBOX_CFLAGS))
EMBOX_IMPORTED_CFLAGS   += $(filter -g,$(EMBOX_CFLAGS))

EMBOX_IMPORTED_CXXFLAGS += $(subst .,$(ROOT_DIR),$(filter -I%,$(EMBOX_CXXFLAGS)))
EMBOX_IMPORTED_CXXFLAGS += $(filter -fno-common,$(EMBOX_CXXFLAGS))
EMBOX_IMPORTED_CXXFLAGS += $(filter -march%,$(EMBOX_CXXFLAGS))
EMBOX_IMPORTED_CXXFLAGS += $(filter -std=gnu99,$(EMBOX_CXXFLAGS))
EMBOX_IMPORTED_CXXFLAGS += $(filter -mlittle-endian,$(EMBOX_CXXFLAGS))
EMBOX_IMPORTED_CXXFLAGS += $(filter -mabi%,$(EMBOX_CXXFLAGS))
EMBOX_IMPORTED_CXXFLAGS += $(filter -mapcs,$(EMBOX_CXXFLAGS))
EMBOX_IMPORTED_CXXFLAGS += $(filter -msoft-float,$(EMBOX_CXXFLAGS))
EMBOX_IMPORTED_CXXFLAGS += $(filter -g,$(EMBOX_CXXFLAGS))

EMBOX_IMPORTED_MAKEFLAGS += $(filter -j,$(EMBOX_MAKEFLAGS))
ifneq ($(filter -j,$(EMBOX_MAKEFLAGS)),)
EMBOX_IMPORTED_MAKEFLAGS += $(shell nproc)
endif
# no wonder the following doesn't work
# EMBOX_IMPORTED_MAKEFLAGS += $(filter --jobserver-fds=%,$(EMBOX_MAKEFLAGS))

EMBOX_DERIVED_CFLAGS    += $(EMBOX_IMPORTED_CFLAGS) -fvisibility=hidden
EMBOX_DERIVED_CXXFLAGS  += $(EMBOX_IMPORTED_CXXFLAGS)  -fvisibility=hidden
EMBOX_DERIVED_MAKEFLAGS += $(EMBOX_IMPORTED_MAKEFLAGS)

all: syslink-driver syslink-lib syslink-slaveloader

syslink-driver: $(SYSLINK_DRIVER)

syslink-lib: $(SYSLINK_LIB)

syslink-slaveloader: $(SYSLINK_SLAVELOADER)

.PHONY: all clean syslink-driver syslink-lib syslink-slaveload

$(SYSLINK_DRIVER):
	$(MAKE) -C $(realpath $(THIRDPARTY_DIR))/ti/syslink_2_21_01_05/packages syslink-driver \
		DEVICE=$(DEVICE) GPPOS=$(GPPOS) LOADER=$(LOADER) EMBOXKERNEL=$(EMBOXKERNEL) \
		SYSLINK_INSTALL_DIR=$(SYSLINK_INSTALL_DIR) IPC_INSTALL_DIR=$(IPC_INSTALL_DIR) \
		SYSLINK_BUILD_DEBUG=$(SYSLINK_BUILD_DEBUG) SYSLINK_BUILD_OPTIMIZE=$(SYSLINK_BUILD_OPTIMIZE) \
		SYSLINK_TRACE_ENABLE=$(SYSLINK_TRACE_ENABLE) \
		SYSLINK_NOTIFYDRIVER=$(SYSLINK_NOTIFYDRIVER) SYSLINK_TRANSPORT=$(SYSLINK_TRANSPORT) \
		CFLAGS='$(EMBOX_DERIVED_CFLAGS) -D__EMBOX_KERNEL__' CXXFLAGS='$(EMBOX_DERIVED_CXXFLAGS) -D__EMBOX_KERNEL__' \
		CC=$(EMBOX_CC) CXX=$(EMBOX_CXX) LD=$(EMBOX_LD) OBJCOPY=$(EMBOX_OBJCOPY)

$(SYSLINK_LIB):
	$(MAKE) -C $(realpath $(THIRDPARTY_DIR))/ti/syslink_2_21_01_05/packages syslink-hlos \
		DEVICE=$(DEVICE) GPPOS=$(GPPOS) LOADER=$(LOADER) EMBOXKERNEL=$(EMBOXKERNEL) \
		SYSLINK_INSTALL_DIR=$(SYSLINK_INSTALL_DIR) IPC_INSTALL_DIR=$(IPC_INSTALL_DIR) \
		SYSLINK_BUILD_DEBUG=$(SYSLINK_BUILD_DEBUG) SYSLINK_BUILD_OPTIMIZE=$(SYSLINK_BUILD_OPTIMIZE) \
		SYSLINK_TRACE_ENABLE=$(SYSLINK_TRACE_ENABLE) \
		SYSLINK_NOTIFYDRIVER=$(SYSLINK_NOTIFYDRIVER) SYSLINK_TRANSPORT=$(SYSLINK_TRANSPORT) \
		CFLAGS='$(EMBOX_DERIVED_CFLAGS)' CXXFLAGS='$(EMBOX_DERIVED_CXXFLAGS)' \
		CC=$(EMBOX_CC) CXX=$(EMBOX_CXX) LD=$(EMBOX_LD) OBJCOPY=$(EMBOX_OBJCOPY)

$(SYSLINK_SLAVELOADER): $(SYSLINK_LIB)
	$(MAKE) -C $(realpath $(THIRDPARTY_DIR))/ti/syslink_2_21_01_05/packages SlaveLoader \
		DEVICE=$(DEVICE) GPPOS=$(GPPOS) LOADER=$(LOADER) EMBOXKERNEL=$(EMBOXKERNEL) \
		SYSLINK_INSTALL_DIR=$(SYSLINK_INSTALL_DIR) IPC_INSTALL_DIR=$(IPC_INSTALL_DIR) \
		SYSLINK_BUILD_DEBUG=$(SYSLINK_BUILD_DEBUG) SYSLINK_BUILD_OPTIMIZE=$(SYSLINK_BUILD_OPTIMIZE) \
		SYSLINK_TRACE_ENABLE=$(SYSLINK_TRACE_ENABLE) \
		SYSLINK_NOTIFYDRIVER=$(SYSLINK_NOTIFYDRIVER) SYSLINK_TRANSPORT=$(SYSLINK_TRANSPORT) \
		CFLAGS='$(EMBOX_DERIVED_CFLAGS)' CXXFLAGS='$(EMBOX_DERIVED_CXXFLAGS)' \
		CC=$(EMBOX_CC) CXX=$(EMBOX_CXX) LD=$(EMBOX_LD) OBJCOPY=$(EMBOX_OBJCOPY)

clean:
	-$(MAKE) -C $(realpath $(THIRDPARTY_DIR))/ti/syslink_2_21_01_05/packages clean \
		DEVICE=$(DEVICE) GPPOS=$(GPPOS) LOADER=$(LOADER) EMBOXKERNEL=$(EMBOXKERNEL) \
		SYSLINK_INSTALL_DIR=$(SYSLINK_INSTALL_DIR) IPC_INSTALL_DIR=$(IPC_INSTALL_DIR) \
		SYSLINK_BUILD_DEBUG=$(SYSLINK_BUILD_DEBUG) SYSLINK_BUILD_OPTIMIZE=$(SYSLINK_BUILD_OPTIMIZE) \
		SYSLINK_TRACE_ENABLE=$(SYSLINK_TRACE_ENABLE) \
		SYSLINK_NOTIFYDRIVER=$(SYSLINK_NOTIFYDRIVER) SYSLINK_TRANSPORT=$(SYSLINK_TRANSPORT) \
		CFLAGS='$(EMBOX_DERIVED_CFLAGS)' CXXFLAGS='$(EMBOX_DERIVED_CXXFLAGS)' \
		CC=$(EMBOX_CC) CXX=$(EMBOX_CXX) LD=$(EMBOX_LD) OBJCOPY=$(EMBOX_OBJCOPY)

