#!/bin/bash

if [ -f $EMBOX_GCC_ENV ]; then
	. $EMBOX_GCC_ENV
else
	echo "No EMBOX_GCC_LINK is set"
	exit 1
fi

case $EMBOX_GCC_LINK in
	full)
	       	ARG_LINE="$EMBOX_IMPORTED_CFLAGS $EMBOX_IMPORTED_LDFLAGS $EMBOX_IMPORTED_LDFLAGS_FULL"
		;;
	*)
	       	ARG_LINE="$EMBOX_IMPORTED_CFLAGS $EMBOX_IMPORTED_LDFLAGS -Wl,-r"
		;;
esac

case $@ in
	*-c*) ARG_LINE="$EMBOX_IMPORTED_CFLAGS";;
	*-E*) ARG_LINE=;;
	*-shared*) echo "Can't build shared objects"; exit 1;;
esac

cmd=$(basename $0)
args=()
for arg in "$@"; do
	arg="${arg//\"/\\\"}"
	arg="${arg//\'/\\\'}"
	if [[ $arg == *\ * ]]; then
		arg="\"$arg\""
	fi
	args+=("$arg")
done

ARG_LINE="${args[@]} $ARG_LINE $EMBOX_IMPORTED_CPPFLAGS"
#echo "eval $EMBOX_CROSS_COMPILE${cmd#arch-embox-} $ARG_LINE" >&2
eval $EMBOX_CROSS_COMPILE${cmd#arch-embox-} $ARG_LINE
exit $?
